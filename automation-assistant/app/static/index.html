<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automation Assistant</title>
    <style>
        :root {
            --primary: #3b82f6;
            --primary-hover: #2563eb;
            --primary-light: rgba(59, 130, 246, 0.1);
            --success: #22c55e;
            --success-light: rgba(34, 197, 94, 0.1);
            --warning: #f59e0b;
            --warning-light: rgba(245, 158, 11, 0.1);
            --error: #ef4444;
            --error-light: rgba(239, 68, 68, 0.1);
            --bg-primary: #0f0f0f;
            --bg-secondary: #171717;
            --bg-card: #1f1f1f;
            --bg-elevated: #262626;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --border: #2e2e2e;
            --border-light: #3f3f46;
            --sidebar-width: 320px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.5;
            min-height: 100vh;
        }

        /* Layout */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 100;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-logo {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .sidebar-subtitle {
            font-size: 12px;
            color: var(--text-muted);
        }

        .sidebar-search {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 36px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2371717a' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 10px center;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .search-input::placeholder { color: var(--text-muted); }

        .sidebar-controls {
            display: flex;
            gap: 8px;
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
        }

        .control-select {
            flex: 1;
            padding: 8px 10px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 12px;
            cursor: pointer;
        }

        .control-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .filter-buttons {
            display: flex;
            gap: 4px;
            padding: 0 20px 12px;
        }

        .filter-btn {
            flex: 1;
            padding: 6px 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover { border-color: var(--border-light); }
        .filter-btn.active {
            background: var(--primary-light);
            border-color: var(--primary);
            color: var(--primary);
        }

        .sidebar-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }

        .sidebar-nav {
            display: flex;
            flex-direction: column;
            gap: 4px;
            margin-bottom: 16px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .nav-item:hover { background: var(--bg-card); color: var(--text-primary); }
        .nav-item.active { background: var(--primary-light); color: var(--primary); }

        .nav-item svg { flex-shrink: 0; }

        .nav-badge {
            margin-left: auto;
            padding: 2px 8px;
            background: var(--error);
            color: white;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }

        .group-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .group-header:hover { background: var(--bg-card); }

        .group-title {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .group-count {
            font-size: 11px;
            color: var(--text-muted);
        }

        .group-chevron {
            transition: transform 0.2s;
        }

        .group-header.collapsed .group-chevron {
            transform: rotate(-90deg);
        }

        .group-items {
            display: flex;
            flex-direction: column;
            gap: 2px;
            margin-bottom: 12px;
        }

        .group-items.collapsed { display: none; }

        .automation-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            width: 100%;
        }

        .automation-item:hover { background: var(--bg-card); }
        .automation-item.selected { background: var(--primary-light); }

        .automation-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
            cursor: help;
        }

        .automation-status.healthy { background: var(--success); }
        .automation-status.warning { background: var(--warning); }
        .automation-status.error { background: var(--error); }
        .automation-status.disabled { background: var(--text-muted); }

        .automation-info { flex: 1; min-width: 0; }

        .automation-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .automation-meta {
            font-size: 11px;
            color: var(--text-muted);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 32px;
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 16px;
            font-weight: 600;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover:not(:disabled) { background: var(--primary-hover); }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .btn-secondary:hover:not(:disabled) { background: var(--border); }

        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }

        /* Welcome View */
        .welcome-header {
            margin-bottom: 32px;
        }

        .welcome-title {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 600;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .stat-card.issues .stat-value { color: var(--warning); }
        .stat-card.errors .stat-value { color: var(--error); }

        .quick-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        /* Forms */
        .form-group { margin-bottom: 20px; }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-input::placeholder, .form-textarea::placeholder {
            color: var(--text-muted);
        }

        /* YAML Editor */
        .yaml-editor {
            width: 100%;
            min-height: 400px;
            padding: 16px;
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 8px;
            color: #7ee787;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: vertical;
        }

        .yaml-editor:focus {
            outline: none;
            border-color: var(--primary);
        }

        .yaml-display {
            background: #0d1117;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            font-family: 'SF Mono', 'Fira Code', monospace;
            font-size: 13px;
            line-height: 1.6;
            color: #7ee787;
        }

        /* Detail View */
        .detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .detail-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .detail-id {
            font-size: 13px;
            color: var(--text-muted);
            font-family: monospace;
        }

        .detail-actions {
            display: flex;
            gap: 8px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-badge.enabled {
            background: var(--success-light);
            color: var(--success);
        }

        .status-badge.disabled {
            background: var(--bg-elevated);
            color: var(--text-muted);
        }

        .section { margin-bottom: 32px; }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        /* Health Status */
        .health-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
        }

        .health-summary {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .health-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .health-icon.healthy { background: var(--success-light); color: var(--success); }
        .health-icon.warning { background: var(--warning-light); color: var(--warning); }
        .health-icon.error { background: var(--error-light); color: var(--error); }

        .health-text {
            font-size: 14px;
            color: var(--text-primary);
        }

        .health-issues {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .health-issue {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .health-issue::before {
            content: "â€¢";
            color: var(--warning);
        }

        /* Executions */
        .execution-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .execution-note {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .execution-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .execution-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        .execution-icon.success { background: var(--success-light); color: var(--success); }
        .execution-icon.error { background: var(--error-light); color: var(--error); }
        .execution-icon.warning { background: var(--warning-light); color: var(--warning); }

        .execution-info { flex: 1; }

        .execution-time {
            font-size: 13px;
            color: var(--text-primary);
        }

        .execution-trigger {
            font-size: 12px;
            color: var(--text-muted);
        }

        .execution-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* AI Modify */
        .ai-modify-row {
            display: flex;
            gap: 12px;
        }

        .ai-modify-input {
            flex: 1;
            min-height: 60px;
        }

        /* Insights Dashboard */
        .insights-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            gap: 4px;
        }

        .insight-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 4px solid var(--border);
        }

        .insight-card.critical { border-left-color: var(--error); }
        .insight-card.warning { border-left-color: var(--warning); }
        .insight-card.info { border-left-color: var(--primary); }

        .insight-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .insight-severity {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .insight-severity.critical { background: var(--error-light); color: var(--error); }
        .insight-severity.warning { background: var(--warning-light); color: var(--warning); }
        .insight-severity.info { background: var(--primary-light); color: var(--primary); }

        .insight-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .insight-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .insight-affected {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }

        .insight-affected strong { color: var(--text-secondary); }

        .insight-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        /* Loading & Empty States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 48px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 32px;
            height: 32px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 12px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .empty-state {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Messages */
        .message {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }

        .message.error {
            background: var(--error-light);
            color: var(--error);
            border: 1px solid var(--error);
        }

        .message.success {
            background: var(--success-light);
            color: var(--success);
            border: 1px solid var(--success);
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 24px;
        }

        .modal.hidden { display: none; }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title { font-size: 18px; font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 24px;
            line-height: 1;
        }

        .modal-close:hover { color: var(--text-primary); }

        .modal-body { padding: 24px; overflow-y: auto; }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .hidden { display: none !important; }

        /* Responsive */
        @media (max-width: 1024px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .main-container { padding: 16px; }
            .stats-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">Automation Assistant</div>
                <div class="sidebar-subtitle">Home Assistant Automations <span id="appVersion" style="opacity: 0.6;"></span></div>
            </div>

            <div class="sidebar-search">
                <input type="text" class="search-input" id="searchInput" placeholder="Search automations...">
            </div>

            <div class="sidebar-controls">
                <select class="control-select" id="groupBySelect">
                    <option value="area">Group by Area</option>
                    <option value="state">Group by Status</option>
                    <option value="alpha">Alphabetical</option>
                    <option value="none">No Grouping</option>
                </select>
            </div>

            <div class="filter-buttons">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="issues">Issues</button>
                <button class="filter-btn" data-filter="disabled">Disabled</button>
            </div>

            <div class="sidebar-list" id="sidebarList">
                <nav class="sidebar-nav">
                    <button class="nav-item active" data-view="welcome">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                        Overview
                    </button>
                    <button class="nav-item" data-view="create">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        Create New
                    </button>
                    <button class="nav-item" data-view="insights">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        Insights
                        <span class="nav-badge hidden" id="insightsBadge">0</span>
                    </button>
                </nav>

                <div id="automationGroups">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="main-container">
                <!-- Welcome View -->
                <div id="welcomeView" class="view">
                    <div class="welcome-header">
                        <h1 class="welcome-title">Welcome to Automation Assistant</h1>
                        <p class="welcome-subtitle">Manage, diagnose, and create Home Assistant automations with AI</p>
                    </div>

                    <div class="stats-grid" id="statsGrid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotal">-</div>
                            <div class="stat-label">Total Automations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statHealthy">-</div>
                            <div class="stat-label">Healthy</div>
                        </div>
                        <div class="stat-card issues">
                            <div class="stat-value" id="statIssues">-</div>
                            <div class="stat-label">With Issues</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statDisabled">-</div>
                            <div class="stat-label">Disabled</div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">System Health</h3>
                        </div>
                        <div id="systemHealth">
                            <p style="color: var(--text-secondary); margin-bottom: 16px;">
                                <span id="lastDiagnosisInfo">No diagnosis run yet</span>
                            </p>
                            <div style="display: flex; gap: 12px;">
                                <button class="btn btn-primary" id="runDiagnosisBtn">Run Full Diagnosis</button>
                                <button class="btn btn-secondary" id="scheduleSettingsBtn">Configure Schedule</button>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Quick Actions</h3>
                        </div>
                        <div class="quick-actions">
                            <button class="btn btn-primary" onclick="showView('create')">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                Create New Automation
                            </button>
                            <button class="btn btn-secondary" onclick="showView('insights')">View All Insights</button>
                        </div>
                    </div>
                </div>

                <!-- Create View -->
                <div id="createView" class="view hidden">
                    <h2 style="margin-bottom: 24px;">Create New Automation</h2>

                    <div id="createError" class="message error hidden"></div>
                    <div id="createSuccess" class="message success hidden"></div>

                    <div class="card">
                        <div class="form-group">
                            <label class="form-label">Describe the automation you want to create</label>
                            <textarea class="form-textarea" id="createPrompt" placeholder="Example: Turn on the living room lights when motion is detected after sunset and turn them off after 5 minutes of no motion"></textarea>
                        </div>
                        <button class="btn btn-primary" id="generateBtn">Generate Automation</button>
                    </div>

                    <div id="createLoading" class="card loading hidden">
                        <div class="spinner"></div>
                        <span>Generating your automation...</span>
                    </div>

                    <div id="createResult" class="card hidden">
                        <div class="section">
                            <h3 class="section-title">Explanation</h3>
                            <div id="createExplanation" style="color: var(--text-secondary); line-height: 1.8;"></div>
                        </div>

                        <div class="section">
                            <div class="section-header">
                                <h3 class="section-title">Generated YAML</h3>
                                <div style="display: flex; gap: 8px;">
                                    <button class="btn btn-sm btn-secondary" id="validateCreateBtn">Validate</button>
                                    <button class="btn btn-sm btn-secondary" id="copyCreateBtn">Copy</button>
                                    <button class="btn btn-sm btn-primary" id="deployCreateBtn">Deploy to HA</button>
                                </div>
                            </div>
                            <pre class="yaml-display" id="createYaml"></pre>
                            <div id="createValidation" class="message hidden" style="margin-top: 12px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Detail View -->
                <div id="detailView" class="view hidden">
                    <div class="detail-header">
                        <div>
                            <h1 class="detail-title" id="detailTitle">Automation Name</h1>
                            <div class="detail-id" id="detailId">automation.id</div>
                        </div>
                        <div class="detail-actions">
                            <span class="status-badge enabled" id="detailStatus">
                                <span id="detailStatusIcon">&#10003;</span>
                                <span id="detailStatusText">Enabled</span>
                            </span>
                        </div>
                    </div>

                    <div id="detailError" class="message error hidden"></div>
                    <div id="detailSuccess" class="message success hidden"></div>

                    <!-- Health Status Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">Health Status</h3>
                            <button class="btn btn-sm btn-secondary" id="diagnoseBtn">Diagnose</button>
                        </div>
                        <div class="health-box" id="healthBox">
                            <div class="health-summary">
                                <div class="health-icon healthy" id="healthIcon">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                </div>
                                <div class="health-text" id="healthText">No issues detected</div>
                            </div>
                            <div class="health-issues hidden" id="healthIssues"></div>
                        </div>
                    </div>

                    <!-- Recent Executions Section -->
                    <div class="section">
                        <h3 class="section-title">Recent Executions</h3>
                        <div class="execution-note hidden" id="executionMeta"></div>
                        <div id="executionLoading" class="loading hidden">
                            <div class="spinner"></div>
                            <span>Loading executions...</span>
                        </div>
                        <div class="execution-list" id="executionList">
                            <div class="empty-state">
                                <p>No recent executions</p>
                            </div>
                        </div>
                    </div>

                    <!-- Modify with AI Section -->
                    <div class="section">
                        <h3 class="section-title">Modify with AI</h3>
                        <div class="ai-modify-row">
                            <textarea class="form-textarea ai-modify-input" id="modifyPrompt" placeholder="Describe the changes you want, e.g., 'Add a 5 minute delay before turning off' or 'Only trigger when it's dark outside'"></textarea>
                            <button class="btn btn-primary" id="modifyBtn" style="align-self: flex-start;">Modify</button>
                        </div>
                        <div id="modifyLoading" class="loading hidden" style="padding: 16px;">
                            <div class="spinner"></div>
                            <span>Modifying...</span>
                        </div>
                    </div>

                    <!-- YAML Section -->
                    <div class="section">
                        <div class="section-header">
                            <h3 class="section-title">YAML</h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" id="copyDetailBtn">Copy</button>
                            </div>
                        </div>
                        <textarea class="yaml-editor" id="detailYaml"></textarea>
                        <div id="detailValidation" class="message hidden" style="margin-top: 12px;"></div>
                        <div style="display: flex; gap: 12px; margin-top: 16px;">
                            <button class="btn btn-primary" id="saveDetailBtn">Save Changes</button>
                            <button class="btn btn-danger" id="deleteDetailBtn">Delete</button>
                        </div>
                    </div>

                    <!-- Diagnosis Results -->
                    <div class="section hidden" id="diagnosisSection">
                        <h3 class="section-title">Diagnosis Results</h3>
                        <div id="diagnosisContent" style="color: var(--text-secondary); line-height: 1.8;"></div>
                    </div>
                </div>

                <!-- Insights View -->
                <div id="insightsView" class="view hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h2>Insights Dashboard</h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <span id="insightsLastRun" style="color: var(--text-muted); font-size: 13px;"></span>
                            <button class="btn btn-primary" id="runInsightsDiagnosis">Run Full Diagnosis</button>
                        </div>
                    </div>

                    <div id="insightsLoading" class="card loading hidden">
                        <div class="spinner"></div>
                        <span>Analyzing all automations...</span>
                    </div>

                    <div class="insights-filters">
                        <div class="filter-group">
                            <button class="filter-btn active" data-severity="all">All</button>
                            <button class="filter-btn" data-severity="critical">Critical</button>
                            <button class="filter-btn" data-severity="warning">Warning</button>
                            <button class="filter-btn" data-severity="info">Info</button>
                        </div>
                    </div>

                    <div id="insightsList">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            </div>
                            <p>No insights yet. Run a full diagnosis to find issues.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Deploy Modal -->
    <div id="deployModal" class="modal hidden">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Deploy to Home Assistant</h2>
                <button class="modal-close" onclick="hideModal('deployModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 16px; color: var(--text-secondary);">This will create or update the automation directly in Home Assistant.</p>
                <div class="form-group">
                    <label class="form-label">Automation ID (optional)</label>
                    <input type="text" class="form-input" id="deployId" placeholder="Leave empty to use ID from YAML">
                </div>
                <pre class="yaml-display" id="deployPreview" style="max-height: 300px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('deployModal')">Cancel</button>
                <button class="btn btn-primary" id="confirmDeployBtn">Deploy</button>
            </div>
        </div>
    </div>

    <!-- Schedule Modal -->
    <div id="scheduleModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Schedule Settings</h2>
                <button class="modal-close" onclick="hideModal('scheduleModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Enable daily diagnosis</label>
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <input type="checkbox" id="scheduleEnabled" checked style="width: 18px; height: 18px;">
                        <span style="color: var(--text-secondary);">Run automatic diagnosis daily</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Run at time (24h format)</label>
                    <input type="text" class="form-input" id="scheduleTime" value="03:00" placeholder="HH:MM" style="width: 120px;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('scheduleModal')">Cancel</button>
                <button class="btn btn-primary" id="saveScheduleBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Delete Automation</h2>
                <button class="modal-close" onclick="hideModal('deleteModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete "<span id="deleteAutomationName"></span>"?</p>
                <p style="color: var(--text-muted); margin-top: 8px;">This cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('deleteModal')">Cancel</button>
                <button class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let automations = [];
        let insights = { single_automation: [], multi_automation: [] };
        let currentAutomation = null;
        let currentView = 'welcome';
        let currentFilter = 'all';
        let currentGroupBy = 'area';
        let searchQuery = '';
        let currentAutomationDetails = null;

        // DOM Elements
        const elements = {
            searchInput: document.getElementById('searchInput'),
            groupBySelect: document.getElementById('groupBySelect'),
            automationGroups: document.getElementById('automationGroups'),
            insightsBadge: document.getElementById('insightsBadge'),
            statsGrid: document.getElementById('statsGrid'),
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            loadVersion();  // Load version immediately, don't await
            await loadAutomations();
            await loadInsights();
            await loadSchedule();
            setupEventListeners();
        });

        // API Functions
        async function loadVersion() {
            try {
                const res = await fetch('api/version');
                if (res.ok) {
                    const data = await res.json();
                    document.getElementById('appVersion').textContent = `v${data.version}`;
                }
            } catch (e) {
                console.warn('Failed to load version:', e);
            }
        }

        async function loadAutomations() {
            try {
                const res = await fetch('api/ha-automations');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                automations = data.automations || [];
                renderAutomationList();
                updateStats();
            } catch (e) {
                console.error('Failed to load automations:', e);
                automations = [];
                document.getElementById('automationGroups').innerHTML = `
                    <div class="empty-state">
                        <p>Failed to load automations</p>
                        <p style="font-size: 12px; color: var(--text-muted);">${escapeHtml(e.message)}</p>
                    </div>
                `;
            }
        }

        async function loadInsights() {
            try {
                const res = await fetch('api/doctor/insights');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                insights = await res.json();
                updateInsightsBadge();
                renderAutomationList();
                updateStats();
                renderInsights();
            } catch (e) {
                console.error('Failed to load insights:', e);
                insights = { single_automation: [], multi_automation: [] };
            }
        }

        async function loadSchedule() {
            try {
                const res = await fetch('api/doctor/schedule');
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                document.getElementById('scheduleEnabled').checked = data.enabled;
                document.getElementById('scheduleTime').value = data.time || '03:00';

                if (data.next_run) {
                    const next = new Date(data.next_run);
                    document.getElementById('lastDiagnosisInfo').textContent =
                        `Next scheduled: ${next.toLocaleString()}`;
                }
            } catch (e) {
                console.error('Failed to load schedule:', e);
            }
        }

        async function loadLatestReport() {
            try {
                const res = await fetch('api/doctor/reports/latest');
                if (res.ok) {
                    const report = await res.json();
                    const runAt = new Date(report.run_at);
                    document.getElementById('lastDiagnosisInfo').textContent =
                        `Last diagnosis: ${runAt.toLocaleString()}`;
                    document.getElementById('insightsLastRun').textContent =
                        `Last: ${runAt.toLocaleString()}`;
                }
            } catch (e) {
                // Ignore
            }
        }

        // Render Functions
        function renderAutomationList() {
            const container = document.getElementById('automationGroups');
            let filtered = filterAutomations(automations);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No automations found</p>
                    </div>
                `;
                return;
            }

            const grouped = groupAutomations(filtered);
            let html = '';

            for (const [groupName, items] of Object.entries(grouped)) {
                html += `
                    <div class="group-header" onclick="toggleGroup(this)">
                        <span class="group-title">${groupName}</span>
                        <span class="group-count">${items.length}</span>
                        <svg class="group-chevron" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    </div>
                    <div class="group-items">
                `;

                for (const auto of items) {
                    const status = getAutomationStatus(auto);
                    const selected = currentAutomation?.id === auto.id ? 'selected' : '';
                    const stateText = auto.state === 'on' ? 'Enabled' : (auto.state === 'off' ? 'Disabled' : 'Unknown');
                    const tooltip = getAutomationTooltip(auto, status, stateText);
                    html += `
                        <button class="automation-item ${selected}" onclick="selectAutomation('${auto.id}')" title="${tooltip}">
                            <div class="automation-status ${status}" title="${tooltip}" aria-label="${tooltip}"></div>
                            <div class="automation-info">
                                <div class="automation-name">${escapeHtml(auto.alias)}</div>
                                <div class="automation-meta">${stateText}</div>
                            </div>
                        </button>
                    `;
                }

                html += '</div>';
            }

            container.innerHTML = html;
        }

        function filterAutomations(list) {
            let filtered = list;

            // Search filter
            if (searchQuery) {
                const q = searchQuery.toLowerCase();
                filtered = filtered.filter(a =>
                    a.alias.toLowerCase().includes(q) ||
                    a.id.toLowerCase().includes(q)
                );
            }

            // Status filter
            if (currentFilter === 'issues') {
                const singleAuto = insights.single_automation || [];
                const multiAuto = insights.multi_automation || [];
                const issueIds = new Set([
                    ...singleAuto.flatMap(i => i.automation_ids),
                    ...multiAuto.flatMap(i => i.automation_ids)
                ]);
                filtered = filtered.filter(a => issueIds.has(a.id));
            } else if (currentFilter === 'disabled') {
                filtered = filtered.filter(a => a.state === 'off');
            }

            return filtered;
        }

        function groupAutomations(list) {
            const groups = {};

            if (currentGroupBy === 'none') {
                groups['All Automations'] = list;
                return groups;
            }

            for (const auto of list) {
                let key;
                if (currentGroupBy === 'area') {
                    key = auto.area_name || 'No Area';
                } else if (currentGroupBy === 'state') {
                    key = auto.state === 'on' ? 'Enabled' : (auto.state === 'off' ? 'Disabled' : 'Unknown');
                } else {
                    key = auto.alias[0]?.toUpperCase() || '#';
                }

                if (!groups[key]) groups[key] = [];
                groups[key].push(auto);
            }

            // Sort groups
            const sorted = {};
            for (const key of Object.keys(groups).sort()) {
                sorted[key] = groups[key].sort((a, b) => a.alias.localeCompare(b.alias));
            }

            return sorted;
        }

        const statusTooltips = {
            healthy: 'Healthy - No issues detected',
            warning: 'Warning - Issues detected or state unknown',
            error: 'Error - Critical issues detected',
            disabled: 'Disabled - Automation is turned off'
        };

        function getAutomationStatus(auto) {
            if (auto.state === 'off') return 'disabled';
            if (auto.state !== 'on') return 'warning';  // unknown state

            const singleAuto = insights.single_automation || [];
            const multiAuto = insights.multi_automation || [];
            const hasIssues = [
                ...singleAuto,
                ...multiAuto
            ].some(i => i.automation_ids.includes(auto.id) && !i.resolved);

            if (hasIssues) {
                const critical = singleAuto.some(
                    i => i.automation_ids.includes(auto.id) && i.severity === 'critical' && !i.resolved
                );
                return critical ? 'error' : 'warning';
            }

            return 'healthy';
        }

        function getAutomationTooltip(auto, status, stateText) {
            const healthText = statusTooltips[status] || 'Status';
            const stateDetail = stateText || 'Unknown';
            return `Health: ${healthText}. State: ${stateDetail}.`;
        }

        function updateStats() {
            const total = automations.length;
            const disabled = automations.filter(a => a.state === 'off').length;

            const singleAuto = insights.single_automation || [];
            const multiAuto = insights.multi_automation || [];
            const issueIds = new Set([
                ...singleAuto.filter(i => !i.resolved).flatMap(i => i.automation_ids),
                ...multiAuto.filter(i => !i.resolved).flatMap(i => i.automation_ids)
            ]);
            const withIssues = automations.filter(a => issueIds.has(a.id)).length;
            const healthy = total - disabled - withIssues;

            document.getElementById('statTotal').textContent = total;
            document.getElementById('statHealthy').textContent = healthy;
            document.getElementById('statIssues').textContent = withIssues;
            document.getElementById('statDisabled').textContent = disabled;
        }

        function updateInsightsBadge() {
            const count = insights.unresolved_count || 0;
            const badge = document.getElementById('insightsBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function renderInsights() {
            const container = document.getElementById('insightsList');
            const all = [...insights.single_automation, ...insights.multi_automation];

            const severityFilter = document.querySelector('[data-severity].active')?.dataset.severity || 'all';
            let filtered = all;

            if (severityFilter !== 'all') {
                filtered = all.filter(i => i.severity === severityFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                        </div>
                        <p>No insights found</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const insight of filtered) {
                html += `
                    <div class="insight-card ${insight.severity}">
                        <div class="insight-header">
                            <span class="insight-severity ${insight.severity}">${insight.severity}</span>
                        </div>
                        <div class="insight-title">${escapeHtml(insight.title)}</div>
                        <div class="insight-description">${escapeHtml(insight.description)}</div>
                        <div class="insight-affected">
                            <strong>Affected:</strong> ${insight.automation_names.join(', ')}
                        </div>
                        <div class="insight-actions">
                            ${insight.automation_ids.length === 1 ?
                                `<button class="btn btn-sm btn-secondary" onclick="selectAutomation('${insight.automation_ids[0]}')">View Automation</button>` :
                                insight.automation_ids.map(id =>
                                    `<button class="btn btn-sm btn-secondary" onclick="selectAutomation('${id}')">View</button>`
                                ).join('')
                            }
                            <button class="btn btn-sm btn-primary" onclick="getInsightFix('${insight.insight_id}')">Get AI Fix</button>
                            <button class="btn btn-sm btn-secondary" onclick="resolveInsight('${insight.insight_id}', ${!insight.resolved})">${insight.resolved ? 'Unresolve' : 'Mark Resolved'}</button>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // View Management
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById(`${viewName}View`).classList.remove('hidden');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');

            currentView = viewName;

            if (viewName !== 'detail') {
                currentAutomation = null;
                renderAutomationList();
            }
        }

        async function selectAutomation(id) {
            const auto = automations.find(a => a.id === id);
            if (!auto) return;

            currentAutomation = auto;
            showView('detail');
            renderAutomationList();

            // Update detail view
            document.getElementById('detailTitle').textContent = auto.alias;
            document.getElementById('detailId').textContent = `automation.${auto.id}`;

            const statusBadge = document.getElementById('detailStatus');
            const statusText = document.getElementById('detailStatusText');
            if (auto.state === 'on') {
                statusBadge.className = 'status-badge enabled';
                statusText.textContent = 'Enabled';
            } else if (auto.state === 'off') {
                statusBadge.className = 'status-badge disabled';
                statusText.textContent = 'Disabled';
            } else {
                statusBadge.className = 'status-badge warning';
                statusText.textContent = 'Unknown';
            }

            // Load automation details
            await loadAutomationDetails(id);
        }

        async function loadAutomationDetails(id) {
            try {
                setExecutionsLoading(true);
                const res = await fetch(`api/ha-automations/${id}`);
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}`);
                }
                const data = await res.json();
                currentAutomationDetails = data;
                executionDisplayLimit = 2;

                // Set YAML
                document.getElementById('detailYaml').value = data.yaml || '';

                // Render executions
                renderExecutions(data.traces || [], data.traces_meta || {});

                // Check for issues
                const singleAuto = insights.single_automation || [];
                const multiAuto = insights.multi_automation || [];
                const autoInsights = [
                    ...singleAuto,
                    ...multiAuto
                ].filter(i => i.automation_ids.includes(id) && !i.resolved);

                const healthIcon = document.getElementById('healthIcon');
                const healthText = document.getElementById('healthText');
                const healthIssues = document.getElementById('healthIssues');

                if (autoInsights.length > 0) {
                    const hasCritical = autoInsights.some(i => i.severity === 'critical');
                    healthIcon.className = `health-icon ${hasCritical ? 'error' : 'warning'}`;
                    healthIcon.innerHTML = hasCritical ?
                        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>' :
                        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>';
                    healthText.textContent = `${autoInsights.length} issue${autoInsights.length > 1 ? 's' : ''} found`;
                    healthIssues.innerHTML = autoInsights.map(i =>
                        `<div class="health-issue">${escapeHtml(i.title)}</div>`
                    ).join('');
                    healthIssues.classList.remove('hidden');
                } else {
                    healthIcon.className = 'health-icon healthy';
                    healthIcon.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>';
                    healthText.textContent = 'No issues detected';
                    healthIssues.classList.add('hidden');
                }

            } catch (e) {
                console.error('Failed to load automation details:', e);
                setExecutionsLoading(false);
                const container = document.getElementById('executionList');
                if (container) {
                    container.innerHTML = '<div class="empty-state"><p>Failed to load executions</p></div>';
                }
            }
        }

        function renderExecutions(traces, meta) {
            const container = document.getElementById('executionList');
            const metaEl = document.getElementById('executionMeta');
            const limit = executionDisplayLimit;

            setExecutionsLoading(false);

            if (metaEl) {
                const metaText = formatTracesMeta(meta, traces);
                metaEl.textContent = metaText;
                metaEl.classList.toggle('hidden', !metaText);
            }

            if (!traces || traces.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>No recent executions</p></div>';
                return;
            }

            const sorted = traces.slice(0, 50).sort((a, b) => {
                const timeA = a.timestamp_start ? new Date(a.timestamp_start) : 0;
                const timeB = b.timestamp_start ? new Date(b.timestamp_start) : 0;
                return timeB - timeA;
            });

            const visible = sorted.slice(0, limit);

            if (metaEl) {
                const metaText = formatTracesMeta(meta, traces, visible.length);
                metaEl.textContent = metaText;
                metaEl.classList.toggle('hidden', !metaText);
            }

            const html = visible.map(t => {
                const startDate = t.timestamp_start ? new Date(t.timestamp_start) : null;
                const finishDate = t.timestamp_finish ? new Date(t.timestamp_finish) : null;
                const time = (startDate && !isNaN(startDate)) ? startDate.toLocaleString() : 'Time not recorded';
                const hasState = Boolean(t.state || t.script_execution);
                const isError = t.error || t.state === 'error';
                const statusLabel = isError ? 'Error' : (hasState ? 'Success' : 'Status not recorded');
                const iconClass = isError ? 'error' : (hasState ? 'success' : 'warning');
                const durationMs = (
                    startDate && finishDate && !isNaN(startDate) && !isNaN(finishDate)
                ) ? finishDate - startDate : null;
                const duration = durationMs !== null && durationMs >= 0 ? formatDuration(durationMs) : null;
                const execution = t.script_execution || t.state;
                const details = [];
                if (t.run_id) {
                    details.push(`Run ${t.run_id.slice(0, 8)}`);
                }
                if (execution) {
                    details.push(`Execution ${execution}`);
                }
                if (duration) {
                    details.push(`Duration ${duration}`);
                }
                const errorText = formatError(t.error);
                if (errorText) {
                    details.push(`Error ${errorText}`);
                }
                if (!errorText && !execution) {
                    details.push('No execution details recorded');
                }
                const detailsHtml = details.length
                    ? `<div class="execution-meta">${escapeHtml(details.join(' â€¢ '))}</div>`
                    : '';
                return `
                    <div class="execution-item">
                        <div class="execution-icon ${iconClass}">
                            ${isError ? 'âœ—' : (hasState ? 'âœ“' : '!')}
                        </div>
                        <div class="execution-info">
                            <div class="execution-time">${time} - ${statusLabel}</div>
                            <div class="execution-trigger">${escapeHtml(formatTrigger(t.trigger))}</div>
                            ${detailsHtml}
                        </div>
                    </div>
                `;
            }).join('');

            let footer = '';
            if (sorted.length > limit) {
                footer = `
                    <div style="display: flex; justify-content: center; margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="showMoreExecutions()">
                            Show more (${sorted.length - limit} more)
                        </button>
                    </div>
                `;
            } else if (sorted.length > 2 && limit > 2) {
                footer = `
                    <div style=\"display: flex; justify-content: center; margin-top: 10px;\">\n                        <button class=\"btn btn-sm btn-secondary\" onclick=\"showFewerExecutions()\">\n                            Show fewer\n                        </button>\n                    </div>\n                `;
            }

            container.innerHTML = html + footer;
        }

        function formatTrigger(trigger) {
            if (!trigger) return 'Trigger details unavailable';
            if (typeof trigger === 'string') return trigger;
            const parts = [];
            if (trigger.description) {
                parts.push(trigger.description);
            } else if (trigger.platform) {
                parts.push(trigger.platform);
            }
            if (trigger.entity_id) {
                parts.push(trigger.entity_id);
            }
            return parts.length ? parts.join(' â€¢ ') : 'Trigger details unavailable';
        }

        function formatDuration(durationMs) {
            if (durationMs < 1000) {
                return `${Math.round(durationMs)}ms`;
            }
            if (durationMs < 60000) {
                return `${(durationMs / 1000).toFixed(1)}s`;
            }
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.round((durationMs % 60000) / 1000);
            return `${minutes}m ${seconds}s`;
        }

        function formatError(error) {
            if (!error) return '';
            if (typeof error === 'string') return truncateText(error, 140);
            if (typeof error === 'object') {
                const message = error.message || error.error || '';
                if (message) return truncateText(message, 140);
                try {
                    return truncateText(JSON.stringify(error), 140);
                } catch (e) {
                    return '';
                }
            }
            return '';
        }

        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return `${text.slice(0, maxLength - 3)}...`;
        }

        let executionDisplayLimit = 2;

        function showMoreExecutions() {
            executionDisplayLimit = Math.min(executionDisplayLimit + 5, 50);
            if (currentAutomationDetails) {
                renderExecutions(currentAutomationDetails.traces || [], currentAutomationDetails.traces_meta || {});
            }
        }

        function showFewerExecutions() {
            executionDisplayLimit = 2;
            if (currentAutomationDetails) {
                renderExecutions(currentAutomationDetails.traces || [], currentAutomationDetails.traces_meta || {});
            }
        }

        function formatTracesMeta(meta, traces, displayedCount) {
            if (!meta || typeof meta !== 'object') return '';
            if (meta.status === 'missing_file') {
                return `Trace history file not found at ${meta.path}. For local runs, set HA_CONFIG_PATH or mount /config.`;
            }
            if (meta.status === 'empty_file') {
                return 'Trace history file is empty.';
            }
            if (meta.status === 'invalid_json') {
                return 'Trace history file could not be parsed.';
            }
            const count = typeof meta.count === 'number' ? meta.count : (traces ? traces.length : 0);
            if (displayedCount) {
                if (count > displayedCount) {
                    return `Showing ${displayedCount} of ${count} recent executions.`;
                }
                return `${count} recent execution${count === 1 ? '' : 's'}.`;
            }
            if (count) {
                return `${count} recent execution${count === 1 ? '' : 's'}.`;
            }
            return '';
        }

        function setExecutionsLoading(isLoading) {
            const loadingEl = document.getElementById('executionLoading');
            const listEl = document.getElementById('executionList');
            const metaEl = document.getElementById('executionMeta');
            if (loadingEl) loadingEl.classList.toggle('hidden', !isLoading);
            if (listEl) listEl.classList.toggle('hidden', isLoading);
            if (metaEl && isLoading) metaEl.classList.add('hidden');
        }

        // Event Listeners
        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', (e) => {
                searchQuery = e.target.value;
                renderAutomationList();
            });

            // Group by
            document.getElementById('groupBySelect').addEventListener('change', (e) => {
                currentGroupBy = e.target.value;
                renderAutomationList();
            });

            // Filter buttons
            document.querySelectorAll('.filter-buttons .filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-buttons .filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderAutomationList();
                });
            });

            // Nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    showView(item.dataset.view);
                });
            });

            // Severity filter
            document.querySelectorAll('[data-severity]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('[data-severity]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderInsights();
                });
            });

            // Generate button
            document.getElementById('generateBtn').addEventListener('click', generateAutomation);

            // Create result buttons
            document.getElementById('validateCreateBtn')?.addEventListener('click', () => validateYaml('create'));
            document.getElementById('copyCreateBtn')?.addEventListener('click', () => copyYaml('create'));
            document.getElementById('deployCreateBtn')?.addEventListener('click', () => showDeployModal('create'));

            // Detail buttons
            document.getElementById('diagnoseBtn')?.addEventListener('click', diagnoseCurrentAutomation);
            document.getElementById('modifyBtn')?.addEventListener('click', modifyAutomation);
            document.getElementById('copyDetailBtn')?.addEventListener('click', () => copyYaml('detail'));
            document.getElementById('saveDetailBtn')?.addEventListener('click', saveAutomation);
            document.getElementById('deleteDetailBtn')?.addEventListener('click', showDeleteModal);

            // Diagnosis buttons
            document.getElementById('runDiagnosisBtn')?.addEventListener('click', runBatchDiagnosis);
            document.getElementById('runInsightsDiagnosis')?.addEventListener('click', runBatchDiagnosis);

            // Schedule
            document.getElementById('scheduleSettingsBtn')?.addEventListener('click', () => showModal('scheduleModal'));
            document.getElementById('saveScheduleBtn')?.addEventListener('click', saveSchedule);

            // Deploy
            document.getElementById('confirmDeployBtn')?.addEventListener('click', deployAutomation);

            // Delete
            document.getElementById('confirmDeleteBtn')?.addEventListener('click', deleteAutomation);
        }

        // Actions
        async function generateAutomation() {
            const prompt = document.getElementById('createPrompt').value.trim();
            if (!prompt) return;

            document.getElementById('createLoading').classList.remove('hidden');
            document.getElementById('createResult').classList.add('hidden');
            document.getElementById('createError').classList.add('hidden');

            try {
                const res = await fetch('api/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt })
                });
                const data = await res.json();

                if (data.success) {
                    document.getElementById('createExplanation').innerHTML = formatMarkdown(data.response);
                    document.getElementById('createYaml').textContent = data.yaml_content || '';
                    document.getElementById('createResult').classList.remove('hidden');
                } else {
                    showError('createError', data.error || 'Failed to generate automation');
                }
            } catch (e) {
                showError('createError', 'Failed to connect to server');
            } finally {
                document.getElementById('createLoading').classList.add('hidden');
            }
        }

        async function diagnoseCurrentAutomation() {
            if (!currentAutomation) return;

            const section = document.getElementById('diagnosisSection');
            const content = document.getElementById('diagnosisContent');

            content.innerHTML = '<div class="loading"><div class="spinner"></div><span>Analyzing...</span></div>';
            section.classList.remove('hidden');

            try {
                const res = await fetch('api/doctor/diagnose', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ automation_id: currentAutomation.id })
                });
                const data = await res.json();

                if (data.success) {
                    content.innerHTML = formatMarkdown(data.analysis);
                } else {
                    content.innerHTML = `<div class="message error">${escapeHtml(data.error)}</div>`;
                }
            } catch (e) {
                content.innerHTML = '<div class="message error">Failed to diagnose automation</div>';
            }
        }

        async function modifyAutomation() {
            if (!currentAutomation) return;

            const prompt = document.getElementById('modifyPrompt').value.trim();
            const yaml = document.getElementById('detailYaml').value;
            if (!prompt) return;

            document.getElementById('modifyLoading').classList.remove('hidden');

            try {
                const res = await fetch('api/modify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, existing_yaml: yaml })
                });
                const data = await res.json();

                if (data.success && data.yaml_content) {
                    document.getElementById('detailYaml').value = data.yaml_content;
                    document.getElementById('modifyPrompt').value = '';
                    showSuccess('detailSuccess', 'Automation modified. Review and save changes.');
                } else {
                    showError('detailError', data.error || 'Failed to modify automation');
                }
            } catch (e) {
                showError('detailError', 'Failed to connect to server');
            } finally {
                document.getElementById('modifyLoading').classList.add('hidden');
            }
        }

        async function saveAutomation() {
            if (!currentAutomation) return;

            const yaml = document.getElementById('detailYaml').value;

            try {
                const res = await fetch('api/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        yaml_content: yaml,
                        automation_id: currentAutomation.id
                    })
                });
                const data = await res.json();

                if (data.success) {
                    showSuccess('detailSuccess', data.message);
                    await loadAutomations();
                } else {
                    showError('detailError', data.detail || 'Failed to save');
                }
            } catch (e) {
                showError('detailError', 'Failed to save automation');
            }
        }

        async function deleteAutomation() {
            // Note: This would need a delete endpoint in the backend
            hideModal('deleteModal');
            showError('detailError', 'Delete not implemented - remove automation from HA directly');
        }

        async function runBatchDiagnosis() {
            document.getElementById('insightsLoading')?.classList.remove('hidden');

            try {
                const res = await fetch('api/doctor/run-batch', { method: 'POST' });
                const data = await res.json();

                await loadInsights();
                await loadAutomations();
                updateStats();

                showView('insights');
            } catch (e) {
                console.error('Batch diagnosis failed:', e);
            } finally {
                document.getElementById('insightsLoading')?.classList.add('hidden');
            }
        }

        async function saveSchedule() {
            const enabled = document.getElementById('scheduleEnabled').checked;
            const time = document.getElementById('scheduleTime').value;

            try {
                await fetch('api/doctor/schedule', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled, time })
                });
                hideModal('scheduleModal');
                await loadSchedule();
            } catch (e) {
                console.error('Failed to save schedule:', e);
            }
        }

        async function validateYaml(source) {
            const yaml = source === 'create'
                ? document.getElementById('createYaml').textContent
                : document.getElementById('detailYaml').value;

            const resultEl = document.getElementById(source === 'create' ? 'createValidation' : 'detailValidation');

            try {
                const res = await fetch('api/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml_content: yaml })
                });
                const data = await res.json();

                resultEl.classList.remove('hidden', 'error', 'success');
                if (data.valid) {
                    resultEl.classList.add('success');
                    resultEl.textContent = 'Valid YAML syntax';
                } else {
                    resultEl.classList.add('error');
                    resultEl.textContent = data.errors?.join(', ') || 'Invalid YAML';
                }
            } catch (e) {
                resultEl.classList.remove('hidden');
                resultEl.classList.add('error');
                resultEl.textContent = 'Failed to validate';
            }
        }

        function copyYaml(source) {
            const yaml = source === 'create'
                ? document.getElementById('createYaml').textContent
                : document.getElementById('detailYaml').value;

            navigator.clipboard.writeText(yaml);
        }

        function showDeployModal(source) {
            const yaml = source === 'create'
                ? document.getElementById('createYaml').textContent
                : document.getElementById('detailYaml').value;

            document.getElementById('deployPreview').textContent = yaml;
            document.getElementById('deployId').value = '';
            showModal('deployModal');
        }

        async function deployAutomation() {
            const yaml = document.getElementById('deployPreview').textContent;
            const id = document.getElementById('deployId').value.trim() || null;

            try {
                const res = await fetch('api/deploy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ yaml_content: yaml, automation_id: id })
                });
                const data = await res.json();

                hideModal('deployModal');

                if (data.success) {
                    showSuccess('createSuccess', data.message);
                    await loadAutomations();
                } else {
                    showError('createError', data.detail || 'Failed to deploy');
                }
            } catch (e) {
                showError('createError', 'Failed to deploy automation');
            }
        }

        async function resolveInsight(insightId, resolved) {
            try {
                await fetch(`api/doctor/insights/${insightId}/resolve?resolved=${resolved}`, {
                    method: 'PUT'
                });
                await loadInsights();
                updateStats();
                renderAutomationList();
            } catch (e) {
                console.error('Failed to resolve insight:', e);
            }
        }

        async function getInsightFix(insightId) {
            // This would open a modal with the fix suggestion
            alert('AI fix generation - coming soon');
        }

        function showDeleteModal() {
            if (!currentAutomation) return;
            document.getElementById('deleteAutomationName').textContent = currentAutomation.alias;
            showModal('deleteModal');
        }

        // Helpers
        function toggleGroup(header) {
            header.classList.toggle('collapsed');
            header.nextElementSibling?.classList.toggle('collapsed');
        }

        function showModal(id) {
            document.getElementById(id).classList.remove('hidden');
        }

        function hideModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden', 'success');
            el.classList.add('error');
        }

        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            el.textContent = message;
            el.classList.remove('hidden', 'error');
            el.classList.add('success');
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/[&<>"']/g, c => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[c]);
        }

        function formatMarkdown(text) {
            if (!text) return '';
            return escapeHtml(text)
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        // Load latest report on init
        loadLatestReport();
    </script>
</body>
</html>
